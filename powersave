#!/usr/bin/env bash
# ===============================================================
# Ubuntu å®¶åº­æœåŠ¡å™¨è‡ªåŠ¨èŠ‚èƒ½ä¼˜åŒ–è„šæœ¬ v2
# é€‚ç”¨äº 24/7 CUDA æœåŠ¡å™¨ï¼šåœ¨é—²æ—¶èŠ‚èƒ½ï¼Œåœ¨è®­ç»ƒæ—¶æ€§èƒ½ä¼˜å…ˆ
# Tested on Ubuntu 22.04â€“25.10
# ===============================================================

set -e

echo ">>> ğŸš€ å¯åŠ¨ Ubuntu å®¶åº­æœåŠ¡å™¨ä¼˜åŒ–æµç¨‹ v2"

# -------------------------------
# 1ï¸âƒ£ ç¡®è®¤éœ€è¦çš„ä»“åº“å·²å¯ç”¨
# -------------------------------
echo ">>> æ£€æŸ¥å¹¶å¯ç”¨ universe ä»“åº“..."
sudo add-apt-repository universe -y >/dev/null 2>&1 || true
sudo apt update -y

# -------------------------------
# 2ï¸âƒ£ å®‰è£…å…³é”®ä¾èµ–
# -------------------------------
echo ">>> å®‰è£…å¸¸ç”¨æ€§èƒ½è°ƒä¼˜å·¥å…·..."
sudo apt install -y ethtool lm-sensors smartmontools hdparm curl wget net-tools pciutils usbutils

# CPU ç”µæºæ§åˆ¶å·¥å…·
echo ">>> å®‰è£… cpupower æˆ–æ›¿ä»£åŒ…..."
sudo apt install -y linux-tools-generic || sudo apt install -y linux-tools-common || true

# PowerTOPï¼šåŠŸè€—åˆ†æä¸è‡ªåŠ¨è°ƒä¼˜
echo ">>> å®‰è£… PowerTOP..."
sudo apt install -y powertop || true

# -------------------------------
# 3ï¸âƒ£ åˆ›å»º powertop-autotune æœåŠ¡ï¼ˆé˜²ä¸¢ï¼‰
# -------------------------------
echo ">>> åˆ›å»º powertop-autotune.service ..."
sudo tee /etc/systemd/system/powertop-autotune.service >/dev/null <<'EOF'
[Unit]
Description=PowerTOP auto tuning
After=multi-user.target

[Service]
Type=simple
ExecStart=/usr/bin/bash -c "sleep 15 && /usr/sbin/powertop --auto-tune"
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable powertop-autotune
sudo systemctl start powertop-autotune || echo "âš ï¸ PowerTOP è‡ªåŠ¨è°ƒä¼˜å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¨åæ£€æŸ¥"

# -------------------------------
# 4ï¸âƒ£ å®‰è£…ç”µæºç®¡ç†å®ˆæŠ¤è¿›ç¨‹ï¼ˆTLP æˆ–æ›¿ä»£ï¼‰
# -------------------------------
echo ">>> å®‰è£…å¹¶å¯ç”¨ TLP æˆ–æ›¿ä»£æ–¹æ¡ˆ..."
if ! dpkg -l | grep -q tlp; then
  sudo apt install -y tlp tlp-rdw || {
    echo "âš ï¸ TLP ä¸å¯ç”¨ï¼Œå°è¯•å®‰è£… power-profiles-daemon..."
    sudo apt install -y power-profiles-daemon
    sudo systemctl enable power-profiles-daemon
    sudo systemctl start power-profiles-daemon
    echo "âœ… å·²å¯ç”¨ power-profiles-daemon æ›¿ä»£ TLP"
  }
else
  sudo systemctl enable tlp
  sudo systemctl start tlp
  echo "âœ… TLP å·²å¯ç”¨"
fi

# -------------------------------
# 5ï¸âƒ£ åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡è„šæœ¬
# -------------------------------
echo ">>> åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡è°ƒèŠ‚è„šæœ¬..."
sudo tee /usr/local/bin/gpu-auto-power.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
# GPU è‡ªåŠ¨åŠŸç‡è°ƒèŠ‚ï¼šæ£€æµ‹ç©ºé—²çŠ¶æ€å¹¶é™ä½åŠŸç‡é™åˆ¶
LOG_FILE="/var/log/gpu_auto_power.log"
IDLE_LIMIT=10   # GPU ä½¿ç”¨ç‡ä½äºæ­¤é˜ˆå€¼åˆ™è§†ä¸ºç©ºé—²ï¼ˆ%ï¼‰
LOW_POWER=60    # ç©ºé—²æ—¶åŠŸç‡é™åˆ¶ï¼ˆç“¦ï¼‰
FULL_POWER=150  # æ´»åŠ¨æ—¶åŠŸç‡é™åˆ¶ï¼ˆç“¦ï¼‰

while true; do
    UTIL=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1)
    if [[ -z "$UTIL" ]]; then
        sleep 60
        continue
    fi

    if (( UTIL < IDLE_LIMIT )); then
        nvidia-smi -pl $LOW_POWER >/dev/null 2>&1
        echo "$(date): GPU idle ($UTIL%), set power limit to ${LOW_POWER}W" >> "$LOG_FILE"
    else
        nvidia-smi -pl $FULL_POWER >/dev/null 2>&1
        echo "$(date): GPU active ($UTIL%), set power limit to ${FULL_POWER}W" >> "$LOG_FILE"
    fi
    sleep 60
done
EOF

sudo chmod +x /usr/local/bin/gpu-auto-power.sh

# åˆ›å»º GPU è‡ªåŠ¨æœåŠ¡
sudo tee /etc/systemd/system/gpu-auto-power.service >/dev/null <<'EOF'
[Unit]
Description=GPU auto power management
After=multi-user.target

[Service]
ExecStart=/usr/local/bin/gpu-auto-power.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable gpu-auto-power
sudo systemctl start gpu-auto-power

# -------------------------------
# 6ï¸âƒ£ ä¼˜åŒ– journald å’Œ swap
# -------------------------------
echo ">>> ä¼˜åŒ– journald æ—¥å¿—ä¸ swap ç­–ç•¥..."
sudo sed -i 's/^#SystemMaxUse=.*$/SystemMaxUse=200M/' /etc/systemd/journald.conf
sudo sed -i 's/^#RuntimeMaxUse=.*$/RuntimeMaxUse=100M/' /etc/systemd/journald.conf
sudo systemctl restart systemd-journald

# é™ä½ swap ä½¿ç”¨å€¾å‘ï¼ˆé¿å…è®­ç»ƒè¢«å¼ºåˆ¶æ¢å‡ºï¼‰
echo "vm.swappiness=10" | sudo tee /etc/sysctl.d/99-swappiness.conf >/dev/null
sudo sysctl -p /etc/sysctl.d/99-swappiness.conf

# -------------------------------
# âœ… å®Œæˆ
# -------------------------------
echo
echo "=============================================================="
echo "ğŸ‰ ä¼˜åŒ–å®Œæˆï¼å½“å‰æœåŠ¡çŠ¶æ€ï¼š"
systemctl is-active powertop-autotune && echo "âœ… PowerTOP è‡ªåŠ¨è°ƒä¼˜è¿è¡Œä¸­"
systemctl is-active tlp && echo "âœ… TLP è¿è¡Œä¸­" || systemctl is-active power-profiles-daemon && echo "âœ… power-profiles-daemon è¿è¡Œä¸­"
systemctl is-active gpu-auto-power && echo "âœ… GPU è‡ªåŠ¨åŠŸç‡è°ƒèŠ‚è¿è¡Œä¸­"
echo "=============================================================="
echo "æç¤ºï¼š"
echo "  â€¢ æŸ¥çœ‹ GPU çŠ¶æ€ï¼šnvidia-smi --query-gpu=power.limit,power.draw --format=csv"
echo "  â€¢ æŸ¥çœ‹èŠ‚èƒ½æƒ…å†µï¼šsudo powertop"
echo "  â€¢ æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼š/var/log/gpu_auto_power.log"
echo "=============================================================="
