#!/usr/bin/env bash
# ===============================================================
# ğŸ”‹ Linux Server Power Optimization Script v4
# Author: Warren & ChatGPT & Grok
# Tested on: Ubuntu 24.04 / 25.10 (Server & Desktop)
# ===============================================================
set -e
echo "==============================================================="
echo "ğŸ”§ è‡ªåŠ¨èŠ‚èƒ½ä¼˜åŒ–è„šæœ¬ v4 å¯åŠ¨ä¸­..."
echo "==============================================================="
# ---------- åŸºç¡€ç¯å¢ƒ ----------
export DEBIAN_FRONTEND=noninteractive
sudo apt update -y || true
# ---------- 1ï¸âƒ£ å®‰è£…ä¾èµ– ----------
echo ">>> å®‰è£… PowerTOP / cpupower / lm-sensors / ethtool ..."
sudo apt install -y powertop linux-tools-common linux-tools-generic lm-sensors ethtool || true
# å°è¯•å®‰è£… cpupower å·¥å…·
if ! command -v cpupower &>/dev/null; then
  echo "âš™ï¸ å®‰è£… cpupower å·¥å…·åŒ…..."
  sudo apt install -y linux-tools-$(uname -r) || true
fi
# ---------- 2ï¸âƒ£ åˆ›å»º powertop-autotune æœåŠ¡ ----------
echo ">>> é…ç½® PowerTOP è‡ªåŠ¨è°ƒä¼˜æœåŠ¡..."
sudo tee /etc/systemd/system/powertop-autotune.service >/dev/null <<'EOF'
[Unit]
Description=PowerTOP auto tuning
After=multi-user.target
[Service]
Type=simple
ExecStart=/usr/bin/bash -c "sleep 15 && /usr/sbin/powertop --auto-tune"
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
sudo systemctl daemon-reload
sudo systemctl enable powertop-autotune
sudo systemctl start powertop-autotune || true
# ---------- 3ï¸âƒ£ å®‰è£… TLP æˆ– Power-Profiles-Daemon ----------
echo ">>> å®‰è£…å¹¶å¯ç”¨ TLP ç”µæºç®¡ç†..."
# ç¦ç”¨ power-profiles-daemonï¼Œé˜²æ­¢å†²çª
sudo systemctl stop power-profiles-daemon 2>/dev/null || true
sudo systemctl disable power-profiles-daemon 2>/dev/null || true
sudo systemctl mask power-profiles-daemon 2>/dev/null || true
# å®‰è£… TLP
if ! dpkg -l | grep -q tlp; then
  sudo apt install -y tlp tlp-rdw || true
fi
# ---------- 3.1ï¸âƒ£ ä¼˜åŒ– TLP é…ç½® ----------
echo ">>> ä¼˜åŒ– TLP é…ç½®..."
sudo tee -a /etc/tlp.conf >/dev/null <<'EOF'
CPU_SCALING_GOVERNOR_ON_AC="powersave"
CPU_SCALING_GOVERNOR_ON_BAT="powersave"
CPU_ENERGY_PERF_POLICY_ON_AC="balance_power"
CPU_ENERGY_PERF_POLICY_ON_BAT="power"
DEVICES_TO_DISABLE_ON_STARTUP="bluetooth wifi wwan"
RUNTIME_PM_ON_AC="auto"
RUNTIME_PM_ON_BAT="auto"
EOF
sudo tlp start || true
# ---------- 4ï¸âƒ£ ä¿®å¤ plymouth å¡æ­»é—®é¢˜ ----------
echo ">>> æ£€æŸ¥å¹¶ä¿®å¤ plymouth å¡æ­»é—®é¢˜..."
if systemctl list-jobs | grep -q "plymouth-quit-wait.service"; then
  echo "âš™ï¸ æ£€æµ‹åˆ° plymouth å¡ä½ï¼Œæ­£åœ¨ä¿®å¤..."
  sudo plymouth quit --retain-splash 2>/dev/null || true
  sudo systemctl stop plymouth-quit-wait.service 2>/dev/null || true
  sudo systemctl disable plymouth-quit-wait.service 2>/dev/null || true
  sudo killall -9 plymouthd 2>/dev/null || true
  sudo systemctl daemon-reexec
  sudo systemctl daemon-reload
fi
# ---------- 5ï¸âƒ£ å¯åŠ¨ TLPï¼Œå¸¦è¶…æ—¶ä¿æŠ¤ ----------
echo ">>> å¯åŠ¨ TLP æœåŠ¡..."
sudo systemctl start tlp &
sleep 5
if systemctl list-jobs | grep -q "tlp.service"; then
  echo "âš ï¸ systemd å¯åŠ¨ TLP è¶…æ—¶ï¼Œæ”¹ç”¨å‘½ä»¤è¡Œæ–¹å¼å¯åŠ¨..."
  sudo killall -9 systemctl 2>/dev/null || true
  sudo tlp start
fi
# ---------- 6ï¸âƒ£ åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡ç®¡ç†è„šæœ¬ ----------
if command -v nvidia-smi &>/dev/null; then
  echo ">>> åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡è°ƒèŠ‚è„šæœ¬..."
  sudo tee /usr/local/bin/gpu-auto-power.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
GPU_MIN=50 # å¾…æœºæ—¶åŠŸç‡é™åˆ¶ (é™ä½é˜ˆå€¼ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–)
GPU_MAX=150 # é«˜è´Ÿè½½æ—¶åŠŸç‡é™åˆ¶
while true; do
    GPU_UTIL=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1)
    if [[ -z "$GPU_UTIL" ]]; then
        sleep 30
        continue
    fi
    if (( GPU_UTIL < 10 )); then
        nvidia-smi -pl $GPU_MIN >/dev/null 2>&1
    elif (( GPU_UTIL > 50 )); then
        nvidia-smi -pl $GPU_MAX >/dev/null 2>&1
    fi
    sleep 20
done
EOF
  sudo chmod +x /usr/local/bin/gpu-auto-power.sh
  sudo tee /etc/systemd/system/gpu-auto-power.service >/dev/null <<'EOF'
[Unit]
Description=GPU Auto Power Management
After=multi-user.target
[Service]
ExecStart=/usr/local/bin/gpu-auto-power.sh
Restart=always
[Install]
WantedBy=multi-user.target
EOF
  sudo systemctl daemon-reload
  sudo systemctl enable gpu-auto-power
  sudo systemctl start gpu-auto-power
  # å¯ç”¨ NVIDIA æŒä¹…æ¨¡å¼
  echo ">>> å¯ç”¨ NVIDIA æŒä¹…æ¨¡å¼..."
  sudo nvidia-smi -pm 1 || true
else
  echo "âš ï¸ æœªæ£€æµ‹åˆ° NVIDIA GPUï¼Œè·³è¿‡ GPU åŠŸç‡ç®¡ç†ã€‚"
fi
# ---------- 7ï¸âƒ£ ä¼˜åŒ– journald ----------
echo ">>> ä¼˜åŒ– systemd-journald..."
sudo bash -c 'cat > /etc/systemd/journald.conf <<EOF
[Journal]
Storage=volatile
RuntimeMaxUse=50M
EOF'
sudo systemctl restart systemd-journald
# ---------- 8ï¸âƒ£ åœç”¨æ— å…³æœåŠ¡ ----------
echo ">>> åœç”¨ä¸å¿…è¦çš„ç³»ç»ŸæœåŠ¡..."
for svc in bluetooth.service cups.service avahi-daemon.service ModemManager.service thermald.service fwupd.service systemd-oomd.service; do
  sudo systemctl stop $svc 2>/dev/null || true
  sudo systemctl disable $svc 2>/dev/null || true
done
sudo systemctl mask accounts-daemon.service 2>/dev/null || true
# ---------- 8.1ï¸âƒ£ CPU è°ƒä¼˜ (å¸¦å®¹é”™) ----------
echo ">>> ä¼˜åŒ– CPU è°ƒåº¦å™¨å’Œç©ºé—²çŠ¶æ€..."
if command -v cpupower &>/dev/null; then
  sudo cpupower frequency-set -g powersave || true
  sudo cpupower idle-set -E || true
else
  echo "âš ï¸ cpupower æœªå®‰è£…æˆ–ä¸æ”¯æŒï¼Œè·³è¿‡ CPU è°ƒä¼˜ã€‚"
fi
# ---------- 8.2ï¸âƒ£ å¯ç”¨ nohz_full (å¦‚æœæ”¯æŒ) ----------
# echo ">>> æ£€æŸ¥å¹¶å¯ç”¨ nohz_full (å¦‚æœå†…æ ¸æ”¯æŒ)..."
# if grep -q "CONFIG_NO_HZ_FULL=y" /boot/config-$(uname -r) 2>/dev/null; then
#   CPU_CORES=$(nproc --all)
#   NOHZ_RANGE="1-$(($CPU_CORES - 1))"
#   if ! grep -q "nohz_full=" /etc/default/grub; then
#     sudo sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"/GRUB_CMDLINE_LINUX_DEFAULT=\"nohz_full=$NOHZ_RANGE /" /etc/default/grub
#     sudo update-grub || true
#     echo "âœ… nohz_full å·²æ·»åŠ åˆ° GRUBï¼Œé‡å¯åç”Ÿæ•ˆã€‚"
#   else
#     echo "âš ï¸ nohz_full å·²é…ç½®ï¼Œè·³è¿‡ã€‚"
#   fi
# else
#   echo "âš ï¸ å†…æ ¸ä¸æ”¯æŒ nohz_fullï¼Œè·³è¿‡ã€‚"
# fi
# ---------- 8.3ï¸âƒ£ ç½‘ç»œå’Œ IRQ ä¼˜åŒ– ----------
echo ">>> ä¼˜åŒ–ç½‘ç»œæ¥å£..."
# ç¦ç”¨ WiFi å¦‚æœå­˜åœ¨
# if command -v nmcli &>/dev/null; then
#   sudo nmcli radio wifi off || true
# fi
# å¯¹äºæ‰€æœ‰ç½‘ç»œæ¥å£ï¼Œç¦ç”¨ WoL å’Œåˆå¹¶ IRQ
for iface in $(ip link show | grep -oP '(?<=: )\w+(?=:)' | grep -v lo); do
  if [[ $iface == eth* || $iface == en* ]]; then
    sudo ethtool -s $iface wol d || true
    sudo ethtool -C $iface rx-usecs 1000 || true
  fi
done
# ---------- 8.4ï¸âƒ£ Sysctl å†…æ ¸å‚æ•°ä¼˜åŒ– ----------
echo ">>> ä¼˜åŒ– sysctl å‚æ•°..."
sudo tee -a /etc/sysctl.conf >/dev/null <<'EOF'
vm.dirty_writeback_centisecs = 1500
vm.swappiness = 10
kernel.nmi_watchdog = 0
EOF
sudo sysctl -p || true
# ---------- 9ï¸âƒ£ éªŒè¯çŠ¶æ€ ----------
echo "==============================================================="
echo "âœ… ä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
echo "---------------------------------------------------------------"
systemctl is-active powertop-autotune && echo "âœ… PowerTOP è‡ªåŠ¨è°ƒä¼˜ï¼šè¿è¡Œä¸­"
systemctl is-active tlp && echo "âœ… TLPï¼šè¿è¡Œä¸­" || echo "âš ï¸ TLP æœªåœ¨ systemd ä¸­è¿è¡Œï¼Œå·²ä½¿ç”¨å‘½ä»¤è¡Œå¯åŠ¨"
systemctl is-active gpu-auto-power && echo "âœ… GPU è‡ªåŠ¨åŠŸç‡ç®¡ç†ï¼šè¿è¡Œä¸­" || echo "âš ï¸ æ—  GPU ç®¡ç†æœåŠ¡"
echo "==============================================================="
echo "ğŸ”‹ ä¼˜åŒ–å®Œæˆï¼å»ºè®®è¿è¡Œ 'sudo powertop' æŸ¥çœ‹æ•ˆæœã€‚"
echo "é‡å¯ç³»ç»Ÿä»¥åº”ç”¨æŸäº›æ›´æ”¹ï¼ˆå¦‚ GRUB é…ç½®ï¼‰ã€‚"
echo "==============================================================="
