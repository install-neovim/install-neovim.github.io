#!/usr/bin/env bash
# ===============================================================
# ğŸ”‹ Linux Server Power Optimization Script v3
# Author: Warren & ChatGPT
# Tested on: Ubuntu 24.04 / 25.10 (Server & Desktop)
# ===============================================================

set -e
echo "==============================================================="
echo "ğŸ”§ è‡ªåŠ¨èŠ‚èƒ½ä¼˜åŒ–è„šæœ¬ v3 å¯åŠ¨ä¸­..."
echo "==============================================================="

# ---------- åŸºç¡€ç¯å¢ƒ ----------
export DEBIAN_FRONTEND=noninteractive
sudo apt update -y || true

# ---------- 1ï¸âƒ£ å®‰è£…ä¾èµ– ----------
echo ">>> å®‰è£… PowerTOP / cpupower / lm-sensors ..."
sudo apt install -y powertop linux-tools-common linux-tools-generic lm-sensors || true

# å°è¯•å®‰è£… cpupower å·¥å…·
if ! command -v cpupower &>/dev/null; then
  echo "âš™ï¸ å®‰è£… cpupower å·¥å…·åŒ…..."
  sudo apt install -y linux-tools-$(uname -r) || true
fi

# ---------- 2ï¸âƒ£ åˆ›å»º powertop-autotune æœåŠ¡ ----------
echo ">>> é…ç½® PowerTOP è‡ªåŠ¨è°ƒä¼˜æœåŠ¡..."
sudo tee /etc/systemd/system/powertop-autotune.service >/dev/null <<'EOF'
[Unit]
Description=PowerTOP auto tuning
After=multi-user.target

[Service]
Type=simple
ExecStart=/usr/bin/bash -c "sleep 15 && /usr/sbin/powertop --auto-tune"
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable powertop-autotune
sudo systemctl start powertop-autotune || true

# ---------- 3ï¸âƒ£ å®‰è£… TLP æˆ– Power-Profiles-Daemon ----------
echo ">>> å®‰è£…å¹¶å¯ç”¨ TLP ç”µæºç®¡ç†..."

# ç¦ç”¨ power-profiles-daemonï¼Œé˜²æ­¢å†²çª
sudo systemctl stop power-profiles-daemon 2>/dev/null || true
sudo systemctl disable power-profiles-daemon 2>/dev/null || true
sudo systemctl mask power-profiles-daemon 2>/dev/null || true

# å®‰è£… TLP
if ! dpkg -l | grep -q tlp; then
  sudo apt install -y tlp tlp-rdw || true
fi

# ---------- 4ï¸âƒ£ ä¿®å¤ plymouth å¡æ­»é—®é¢˜ ----------
echo ">>> æ£€æŸ¥å¹¶ä¿®å¤ plymouth å¡æ­»é—®é¢˜..."
if systemctl list-jobs | grep -q "plymouth-quit-wait.service"; then
  echo "âš™ï¸ æ£€æµ‹åˆ° plymouth å¡ä½ï¼Œæ­£åœ¨ä¿®å¤..."
  sudo plymouth quit --retain-splash 2>/dev/null || true
  sudo systemctl stop plymouth-quit-wait.service 2>/dev/null || true
  sudo systemctl disable plymouth-quit-wait.service 2>/dev/null || true
  sudo killall -9 plymouthd 2>/dev/null || true
  sudo systemctl daemon-reexec
  sudo systemctl daemon-reload
fi

# ---------- 5ï¸âƒ£ å¯åŠ¨ TLPï¼Œå¸¦è¶…æ—¶ä¿æŠ¤ ----------
echo ">>> å¯åŠ¨ TLP æœåŠ¡..."
sudo systemctl start tlp &

sleep 5
if systemctl list-jobs | grep -q "tlp.service"; then
  echo "âš ï¸ systemd å¯åŠ¨ TLP è¶…æ—¶ï¼Œæ”¹ç”¨å‘½ä»¤è¡Œæ–¹å¼å¯åŠ¨..."
  sudo killall -9 systemctl 2>/dev/null || true
  sudo tlp start
fi

# ---------- 6ï¸âƒ£ åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡ç®¡ç†è„šæœ¬ ----------
if command -v nvidia-smi &>/dev/null; then
  echo ">>> åˆ›å»º GPU è‡ªåŠ¨åŠŸç‡è°ƒèŠ‚è„šæœ¬..."
  sudo tee /usr/local/bin/gpu-auto-power.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
GPU_MIN=60    # å¾…æœºæ—¶åŠŸç‡é™åˆ¶
GPU_MAX=150   # é«˜è´Ÿè½½æ—¶åŠŸç‡é™åˆ¶

while true; do
    GPU_UTIL=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1)
    if [[ -z "$GPU_UTIL" ]]; then
        sleep 30
        continue
    fi

    if (( GPU_UTIL < 10 )); then
        nvidia-smi -pl $GPU_MIN >/dev/null 2>&1
    elif (( GPU_UTIL > 50 )); then
        nvidia-smi -pl $GPU_MAX >/dev/null 2>&1
    fi
    sleep 20
done
EOF
  sudo chmod +x /usr/local/bin/gpu-auto-power.sh

  sudo tee /etc/systemd/system/gpu-auto-power.service >/dev/null <<'EOF'
[Unit]
Description=GPU Auto Power Management
After=multi-user.target

[Service]
ExecStart=/usr/local/bin/gpu-auto-power.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

  sudo systemctl daemon-reload
  sudo systemctl enable gpu-auto-power
  sudo systemctl start gpu-auto-power
else
  echo "âš ï¸ æœªæ£€æµ‹åˆ° NVIDIA GPUï¼Œè·³è¿‡ GPU åŠŸç‡ç®¡ç†ã€‚"
fi

# ---------- 7ï¸âƒ£ ä¼˜åŒ– journald ----------
echo ">>> ä¼˜åŒ– systemd-journald..."
sudo bash -c 'cat > /etc/systemd/journald.conf <<EOF
[Journal]
Storage=volatile
RuntimeMaxUse=50M
EOF'
sudo systemctl restart systemd-journald

# ---------- 8ï¸âƒ£ åœç”¨æ— å…³æœåŠ¡ ----------
echo ">>> åœç”¨ä¸å¿…è¦çš„ç³»ç»ŸæœåŠ¡..."
for svc in bluetooth.service cups.service avahi-daemon.service ModemManager.service thermald.service; do
  sudo systemctl stop $svc 2>/dev/null || true
  sudo systemctl disable $svc 2>/dev/null || true
done

# ---------- 9ï¸âƒ£ éªŒè¯çŠ¶æ€ ----------
echo "==============================================================="
echo "âœ… ä¼˜åŒ–å®Œæˆï¼Œæ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
echo "---------------------------------------------------------------"
systemctl is-active powertop-autotune && echo "âœ… PowerTOP è‡ªåŠ¨è°ƒä¼˜ï¼šè¿è¡Œä¸­"
systemctl is-active tlp && echo "âœ… TLPï¼šè¿è¡Œä¸­" || echo "âš ï¸ TLP æœªåœ¨ systemd ä¸­è¿è¡Œï¼Œå·²ä½¿ç”¨å‘½ä»¤è¡Œå¯åŠ¨"
systemctl is-active gpu-auto-power && echo "âœ… GPU è‡ªåŠ¨åŠŸç‡ç®¡ç†ï¼šè¿è¡Œä¸­" || echo "âš ï¸ æ—  GPU ç®¡ç†æœåŠ¡"
echo "==============================================================="
echo "ğŸ”‹ ä¼˜åŒ–å®Œæˆï¼å»ºè®®è¿è¡Œ 'sudo powertop' æŸ¥çœ‹æ•ˆæœã€‚"
echo "==============================================================="
