#!/bin/bash
# ===========================================================
#  CUDA å®¶åº­æœåŠ¡å™¨èŠ‚èƒ½ä¼˜åŒ–è„šæœ¬
#  ä½œè€…ï¼šChatGPT  (for Warren)
# ===========================================================

echo "=== ðŸš€ å¼€å§‹æ‰§è¡ŒæœåŠ¡å™¨èŠ‚èƒ½ä¼˜åŒ–è®¾ç½® ==="

# -----------------------------------------------------------
# 1. åŸºç¡€ä¾èµ–
# -----------------------------------------------------------
sudo apt update
sudo apt install -y powertop tlp tlp-rdw cpupower git

# -----------------------------------------------------------
# 2. å¯ç”¨ PowerTOP è‡ªåŠ¨è°ƒä¼˜
# -----------------------------------------------------------
echo ">>> å¯ç”¨ PowerTOP è‡ªåŠ¨è°ƒä¼˜..."
sudo tee /etc/systemd/system/powertop.service >/dev/null <<'EOF'
[Unit]
Description=PowerTOP auto tuning

[Service]
Type=oneshot
ExecStart=/usr/sbin/powertop --auto-tune

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable powertop
sudo systemctl start powertop

# -----------------------------------------------------------
# 3. å¯ç”¨å¹¶é…ç½® TLP
# -----------------------------------------------------------
echo ">>> å¯ç”¨ TLP ç”µæºç®¡ç†..."
sudo systemctl enable tlp
sudo systemctl start tlp

sudo sed -i 's/^#CPU_SCALING_GOVERNOR_ON_AC=.*/CPU_SCALING_GOVERNOR_ON_AC=performance/' /etc/tlp.conf
sudo sed -i 's/^#CPU_SCALING_GOVERNOR_ON_BAT=.*/CPU_SCALING_GOVERNOR_ON_BAT=powersave/' /etc/tlp.conf
sudo sed -i 's/^#NMI_WATCHDOG=.*/NMI_WATCHDOG=0/' /etc/tlp.conf
sudo sed -i 's/^#SCHED_POWERSAVE_ON_AC=.*/SCHED_POWERSAVE_ON_AC=1/' /etc/tlp.conf
sudo sed -i 's/^#RUNTIME_PM_ON_AC=.*/RUNTIME_PM_ON_AC=auto/' /etc/tlp.conf
sudo sed -i 's/^#PCIE_ASPM_ON_AC=.*/PCIE_ASPM_ON_AC=performance/' /etc/tlp.conf

# -----------------------------------------------------------
# 4. å…³é—­æ— å…³å¸¸é©»æœåŠ¡
# -----------------------------------------------------------
echo ">>> åœç”¨ä¸å¿…è¦çš„ç³»ç»ŸæœåŠ¡..."
for svc in plymouth bluetooth avahi-daemon cups fwupd systemd-oomd apache2; do
  sudo systemctl disable --now $svc 2>/dev/null
done

# -----------------------------------------------------------
# 5. ä¼˜åŒ–æ—¥å¿—ç³»ç»Ÿ
# -----------------------------------------------------------
echo ">>> ä¼˜åŒ– systemd-journald..."
sudo sed -i 's/^#Storage=.*/Storage=volatile/' /etc/systemd/journald.conf
sudo systemctl restart systemd-journald

# -----------------------------------------------------------
# 6. å®‰è£… auto-cpufreq æ™ºèƒ½ CPU è°ƒé¢‘å·¥å…·
# -----------------------------------------------------------
echo ">>> å®‰è£… auto-cpufreq..."
if ! command -v auto-cpufreq &>/dev/null; then
  git clone https://github.com/AdnanHodzic/auto-cpufreq.git /tmp/auto-cpufreq
  cd /tmp/auto-cpufreq && sudo ./auto-cpufreq-installer
  sudo auto-cpufreq --install
fi

# -----------------------------------------------------------
# 7. åˆ›å»º GPU åŠ¨æ€åŠŸçŽ‡ç®¡ç†è„šæœ¬
# -----------------------------------------------------------
echo ">>> åˆ›å»º GPU åŠ¨æ€åŠŸçŽ‡ç®¡ç†è„šæœ¬..."
sudo tee /usr/local/bin/gpu-auto-power.sh >/dev/null <<'EOF'
#!/bin/bash
# è‡ªåŠ¨æ ¹æ® GPU è´Ÿè½½è°ƒèŠ‚åŠŸçŽ‡é™åˆ¶
HIGH_POWER=150
LOW_POWER=60
GPU_IDLE_THRESHOLD=3
SLEEP_INTERVAL=60

while true; do
  util=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits)
  if [ "$util" -lt "$GPU_IDLE_THRESHOLD" ]; then
    nvidia-smi -pl $LOW_POWER > /dev/null
  else
    nvidia-smi -pl $HIGH_POWER > /dev/null
  fi
  sleep $SLEEP_INTERVAL
done
EOF
sudo chmod +x /usr/local/bin/gpu-auto-power.sh

# -----------------------------------------------------------
# 8. æ³¨å†Œ GPU è‡ªåŠ¨è°ƒèŠ‚æœåŠ¡
# -----------------------------------------------------------
sudo tee /etc/systemd/system/gpu-auto-power.service >/dev/null <<'EOF'
[Unit]
Description=Auto GPU Power Management
After=network.target

[Service]
ExecStart=/usr/local/bin/gpu-auto-power.sh
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable gpu-auto-power
sudo systemctl start gpu-auto-power

# -----------------------------------------------------------
# 9. æ”¶å°¾
# -----------------------------------------------------------
echo "=== âœ… èŠ‚èƒ½ä¼˜åŒ–å·²å®Œæˆï¼ ==="
echo "ç³»ç»Ÿå°†ï¼š"
echo " - è‡ªåŠ¨åº”ç”¨ powertop èŠ‚èƒ½è°ƒä¼˜"
echo " - å¯ç”¨ TLP ä¼˜åŒ– CPU/PCIe ç”µæº"
echo " - è‡ªåŠ¨è°ƒèŠ‚ GPU åŠŸçŽ‡ï¼ˆç©ºé—²é™åŠŸçŽ‡ï¼‰"
echo " - æ™ºèƒ½ CPU è°ƒé¢‘ï¼ˆauto-cpufreqï¼‰"
echo " - ç¦ç”¨æ— å…³åŽå°æœåŠ¡"
echo
echo "å»ºè®®è¿è¡Œï¼šsudo powertop è§‚å¯Ÿ Wakeups æ˜¯å¦æ˜¾è‘—ä¸‹é™ (<100 wakeups/s)"

