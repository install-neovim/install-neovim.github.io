#!/usr/bin/env bash
set -e

# ===== 基本变量 =====
RIME_REPO_URL="https://github.com/iDvel/rime-ice.git"
RIME_REPO_DIR="$HOME/Rime"

FCITX5_THEME_REPO_URL="https://github.com/thep0y/fcitx5-themes-candlelight.git"
FCITX5_THEME_REPO_DIR="$HOME/fcitx5-themes-candlelight"
FCITX5_THEME_DIR="$HOME/.local/share/fcitx5/themes"

echo "=============================================="
echo "   Rime 雾凇输入法 (rime-ice) 一键配置脚本"
echo "=============================================="
echo
echo "请选择你正在使用的输入法框架："
echo
echo "  1) ibus + ibus-rime"
echo "  2) fcitx5 + fcitx5-rime （含主题安装）"
echo
read -rp "请输入选项 [1/2] 后回车: " CHOICE
echo

case "$CHOICE" in
1)
  FRAMEWORK="ibus"
  RIME_DIR="$HOME/.config/ibus/rime"
  ;;
2)
  FRAMEWORK="fcitx5"
  RIME_DIR="$HOME/.local/share/fcitx5/rime"
  ;;
*)
  echo "❌ 无效选择，退出"
  exit 1
  ;;
esac

echo "==> 选择输入法框架: $FRAMEWORK"
echo "==> Rime 配置目录: $RIME_DIR"
echo

# ===== Rime 基础配置 =====
mkdir -p "$RIME_DIR"

if [ ! -d "$RIME_REPO_DIR/.git" ]; then
  echo "==> 克隆 rime-ice"
  git clone --depth 1 "$RIME_REPO_URL" "$RIME_REPO_DIR"
else
  echo "==> 更新 rime-ice"
  git -C "$RIME_REPO_DIR" pull
fi

echo "==> 同步 rime 配置文件"
cp -r "$RIME_REPO_DIR"/* "$RIME_DIR"/

DEFAULT_YAML="$RIME_DIR/default.yaml"
if [ -f "$DEFAULT_YAML" ]; then
  echo "==> 设置 Shift_R: commit_code"
  sed -i 's/Shift_R: noop/Shift_R: commit_code/' "$DEFAULT_YAML"
fi

# ===== fcitx5 主题配置 =====
if [ "$FRAMEWORK" = "fcitx5" ]; then
  echo
  echo "==> 配置 fcitx5 主题（candlelight）"

  mkdir -p "$FCITX5_THEME_DIR"

  if [ ! -d "$FCITX5_THEME_REPO_DIR/.git" ]; then
    echo "==> 克隆 fcitx5-themes-candlelight"
    git clone "$FCITX5_THEME_REPO_URL" "$FCITX5_THEME_REPO_DIR"
  else
    echo "==> 更新 fcitx5-themes-candlelight"
    git -C "$FCITX5_THEME_REPO_DIR" pull
  fi

  echo "==> 可用主题："
  ls "$FCITX5_THEME_REPO_DIR"
  echo
  echo "⚠️  请手动选择一个主题名称，并按说明复制，例如："
  echo "    cp -r $FCITX5_THEME_REPO_DIR/spring $FCITX5_THEME_DIR/"
fi

# ===== 重启输入法 =====
echo
echo "==> 重启输入法框架"
if [ "$FRAMEWORK" = "ibus" ]; then
  ibus-daemon -drx
else
  fcitx5 -r
fi

# ===== 后续微调说明 =====
if [ "$FRAMEWORK" = "fcitx5" ]; then
  cat <<'EOF'

==================================================
fcitx5 可选微调配置说明（手动）
==================================================

1️⃣ 启用主题（classic UI）：
编辑：
  ~/.config/fcitx5/conf/classicui.conf

添加或修改（示例）：
  Vertical Candidate List=False
  PerScreenDPI=True
  Font="Smartisan Compact CNS 13"
  Theme=<theme-name>

其中 <theme-name> 替换为你复制的主题名，如：
  spring / summer / autumn / winter
  green / transparent-green
  macOS-light / macOS-dark

--------------------------------------------------

2️⃣ fcitx5-rime 单行模式（应用内预编辑）：
编辑：
  ~/.config/fcitx5/conf/rime.conf

添加：
  PreeditInApplication=True

--------------------------------------------------

3️⃣ 单行 / 双行模式快捷键切换：
  Ctrl + Alt + P

--------------------------------------------------

4️⃣ 应用修改：
  重启 fcitx5：
    fcitx5 -r

==================================================

EOF
fi

echo "✅ 配置完成"
