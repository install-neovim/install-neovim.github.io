#!/usr/bin/env bash
set -e

# ==================================================
# Rime 雾凇输入法（rime-ice）全自动配置脚本
# 支持 ibus / fcitx5
# ==================================================

RIME_REPO_URL="https://github.com/iDvel/rime-ice.git"
RIME_REPO_DIR="$HOME/Rime"

FCITX5_THEME_REPO_URL="https://github.com/thep0y/fcitx5-themes-candlelight.git"
FCITX5_THEME_REPO_DIR="$HOME/fcitx5-themes-candlelight"
FCITX5_THEME_DIR="$HOME/.local/share/fcitx5/themes"
DEFAULT_FCITX5_THEME="macOS-dark"

echo "=============================================="
echo "   Rime 雾凇输入法 (rime-ice) 一键配置脚本"
echo "=============================================="
echo
echo "请选择你正在使用的输入法框架："
echo
echo "  1) ibus + ibus-rime"
echo "  2) fcitx5 + fcitx5-rime（推荐，含主题）"
echo
read -rp "请输入选项 [1/2] 后回车: " CHOICE
echo

# ===== 发行版检测 =====
detect_pkg_mgr() {
  if command -v apt >/dev/null; then
    PKG_MGR="apt"
  elif command -v pacman >/dev/null; then
    PKG_MGR="pacman"
  elif command -v dnf >/dev/null; then
    PKG_MGR="dnf"
  else
    PKG_MGR="unknown"
  fi
}

install_pkgs() {
  case "$PKG_MGR" in
  apt) sudo apt update && sudo apt install -y "$@" ;;
  pacman) sudo pacman -Sy --noconfirm "$@" ;;
  dnf) sudo dnf install -y "$@" ;;
  *)
    echo "❌ 无法识别包管理器，请手动安装：$*"
    ;;
  esac
}

remove_pkgs() {
  case "$PKG_MGR" in
  apt) sudo apt purge -y "$@" ;;
  pacman) sudo pacman -Rns --noconfirm "$@" ;;
  dnf) sudo dnf remove -y "$@" ;;
  *)
    echo "⚠ 请手动卸载：$*"
    ;;
  esac
}

detect_pkg_mgr

case "$CHOICE" in
1)
  FRAMEWORK="ibus"
  RIME_DIR="$HOME/.config/ibus/rime"

  echo "==> 安装 ibus + ibus-rime"
  install_pkgs ibus ibus-rime

  echo "==> 卸载 fcitx / fcitx5"
  remove_pkgs fcitx fcitx5 fcitx5-rime || true
  ;;
2)
  FRAMEWORK="fcitx5"
  RIME_DIR="$HOME/.local/share/fcitx5/rime"

  echo "==> 安装 fcitx5 + fcitx5-rime"
  install_pkgs \
    fcitx5 \
    fcitx5-rime \
    fcitx5-configtool \
    fcitx5-gtk \
    fcitx5-qt

  echo "==> 卸载 ibus / fcitx"
  remove_pkgs ibus ibus-rime fcitx || true
  ;;
*)
  echo "❌ 无效选择，退出"
  exit 1
  ;;
esac

echo
echo "==> 选择输入法框架: $FRAMEWORK"
echo "==> Rime 配置目录: $RIME_DIR"
echo

# ===== Rime 基础配置 =====
mkdir -p "$RIME_DIR"

if [ ! -d "$RIME_REPO_DIR/.git" ]; then
  echo "==> 克隆 rime-ice"
  git clone --depth 1 "$RIME_REPO_URL" "$RIME_REPO_DIR"
else
  echo "==> 更新 rime-ice"
  git -C "$RIME_REPO_DIR" pull
fi

echo "==> 同步 rime 配置文件"
cp -r "$RIME_REPO_DIR"/* "$RIME_DIR"/

DEFAULT_YAML="$RIME_DIR/default.yaml"
if [ -f "$DEFAULT_YAML" ]; then
  echo "==> 设置 Shift_R: commit_code"
  sed -i 's/Shift_R: noop/Shift_R: commit_code/' "$DEFAULT_YAML"
fi

# ===== fcitx5 主题自动配置 =====
if [ "$FRAMEWORK" = "fcitx5" ]; then
  echo
  echo "==> 配置 fcitx5 主题（candlelight）"

  mkdir -p "$FCITX5_THEME_DIR"

  if [ ! -d "$FCITX5_THEME_REPO_DIR/.git" ]; then
    git clone "$FCITX5_THEME_REPO_URL" "$FCITX5_THEME_REPO_DIR"
  else
    git -C "$FCITX5_THEME_REPO_DIR" pull
  fi

  echo "==> 安装默认主题: $DEFAULT_FCITX5_THEME"
  rm -rf "$FCITX5_THEME_DIR/$DEFAULT_FCITX5_THEME"
  cp -r "$FCITX5_THEME_REPO_DIR/$DEFAULT_FCITX5_THEME" "$FCITX5_THEME_DIR/"

  mkdir -p "$HOME/.config/fcitx5/conf"

  cat >"$HOME/.config/fcitx5/conf/classicui.conf" <<EOF
Vertical Candidate List=False
PerScreenDPI=True
Font="Smartisan Compact CNS 13"
Theme=$DEFAULT_FCITX5_THEME
EOF

  cat >"$HOME/.config/fcitx5/conf/rime.conf" <<EOF
PreeditInApplication=True
EOF
fi

# ===== 重启输入法 =====
echo
echo "==> 重启输入法框架"
if [ "$FRAMEWORK" = "ibus" ]; then
  ibus-daemon -drx
else
  fcitx5 -r || fcitx5 &
fi

# ===== 后续说明 =====
cat <<'EOF'

==================================================
输入法自启动设置提醒（非常重要）
==================================================

【fcitx5】
1) 确认环境变量：
   GTK_IM_MODULE=fcitx
   QT_IM_MODULE=fcitx
   XMODIFIERS=@im=fcitx

2) systemd 用户服务：
   systemctl --user enable fcitx5
   systemctl --user start fcitx5

3) 桌面环境：
   设置 → 启动应用 → 添加 fcitx5

--------------------------------------------------

【ibus】
1) 设置为默认输入法：
   im-config -n ibus

2) 启动：
   ibus-daemon -drx

--------------------------------------------------

【fcitx5 主题修改说明（已自动设置 macOS-dark）】

配置文件：
  ~/.config/fcitx5/conf/classicui.conf

可选主题：
  spring / summer / autumn / winter
  green / transparent-green
  macOS-light / macOS-dark

修改后执行：
  fcitx5 -r

==================================================

EOF

echo "✅ Rime 雾凇输入法配置完成"
